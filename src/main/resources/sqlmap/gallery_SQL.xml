<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.brownie.gallery.service.impl.GalleryMapper">
    <select id="selectList" resultType="kr.co.brownie.gallery.service.GalleryVO">
        select S.RNUM,
               S.BOARDSEQ AS BOARDSEQ,
               S.BOARDKIND AS BOARDKIND,
               S.TITLE AS TITLE,
               S.CONTENT AS CONTENT,
               S.NOTICEYN AS NOTICEYN,
               S.STATUS AS STATUS,
               S.INDATE AS INDATE,
               S.INUSERID AS INUSERID,
               S.MODDATE AS "UPDATE",
               S.UPUSERID AS UPUSERID,
               (SELECT SAVE_NAME FROM BROWNIE_FILE WHERE FILE_SEQ = S.FILESEQ AND SUB_SEQ =1) AS FILESEQ,
               (SELECT COUNT(*) as cnt FROM HIT WHERE 1=1 AND BOARD_SEQ = S.BOARDSEQ) AS SUBSEQ,
               S.LOVE AS LOVE,
               S.HATE AS HATE
        FROM
            (SELECT ROWNUM RNUM , T.*
                FROM(
                    SELECT
                        BOARD_SEQ AS BOARDSEQ,
                        BOARD_KIND AS BOARDKIND,
                        TITLE AS TITLE,
                        CONTENT AS CONTENT,
                        NOTICE_YN AS NOTICEYN,
                        STATUS AS STATUS,
                        IN_DATE AS INDATE,
                        IN_USER_ID AS INUSERID,
                        UP_DATE AS MODDATE,
                        UP_USER_ID AS UPUSERID,
                        FILE_SEQ AS FILESEQ,
                        SUB_SEQ AS SUBSEQ,
                        (SELECT COUNT(*) FROM LIKE_BOARD C WHERE C.BOARD_SEQ = D.BOARD_SEQ AND C.KIND = 0) AS LOVE,
                        (SELECT COUNT(*) FROM LIKE_BOARD C WHERE C.BOARD_SEQ = D.BOARD_SEQ AND C.KIND = 1) AS HATE
                    FROM BROWNIE_BOARD D
                    WHERE 1 = 1
                    AND BOARD_KIND='GALLERY'
                    ORDER BY BOARD_SEQ DESC
            )T
        )S
        WHERE S.RNUM BETWEEN TO_NUMBER(#{pageNum})*18-17 AND TO_NUMBER(#{pageNum})*18

    </select>
	
	<select id="selectFiles" parameterType="int" resultType="kr.co.brownie.gallery.service.FileVO">
        SELECT FILE_SEQ AS FILESEQ,
               SUB_SEQ AS SUBSEQ,
               FILE_PATH AS FILEPATH,
               ORIGINAL_NAME AS ORIGINALNAME,
               SAVE_NAME AS SAVENAME,
               IN_DATE AS INDATE,
               IN_USER_ID AS INUSERID,
               UP_DATE AS MODDATE,
               UP_USER_ID AS UPUSERID
        FROM BROWNIE_FILE
        WHERE FILE_SEQ = #{fileSeq}
    </select>
    
	<select id="selectFile" parameterType="String" resultType="int">
        SELECT FILE_SEQ AS FILESEQ
        FROM BROWNIE_FILE
        WHERE SAVE_NAME = #{fileName}
    </select>
	
	<select id="noticeList" resultType="kr.co.brownie.gallery.service.GalleryVO">
       SELECT S.RNUM,
       S.BOARDSEQ  AS BOARDSEQ,
       S.BOARDCATEGORY AS BOARDCATEGORY,
       S.TITLE      AS TITLE,
       S.CONTENT    AS CONTENT,
       S.NOTICEYN  AS NOTICEYN,
       S.STATUS     AS STATUS,
       S.INDATE    AS INDATE,
       S.INUSERID AS INUSERID,
       S.MODDATE    AS "UPDATE",
       S.UPUSERID AS UPUSERID,
       S.FILESEQ   AS FILESEQ,
       (SELECT COUNT(*) as cnt FROM HIT WHERE 1=1 AND BOARD_SEQ = S.BOARDSEQ) AS SUBSEQ,
       S.LOVE AS LOVE,
       S.HATE AS HATE
		FROM 
		(SELECT ROWNUM RNUM , T.*
		        FROM(
		            SELECT
		                BOARD_SEQ AS BOARDSEQ,
		                BOARD_CATEGORY AS BOARDCATEGORY,
		                TITLE AS TITLE,
		                CONTENT AS CONTENT,
		                NOTICE_YN AS NOTICEYN,
		                STATUS AS STATUS,
		                IN_DATE AS INDATE,
		                IN_USER_ID AS INUSERID,
		                UP_DATE AS MODDATE,
		                UP_USER_ID AS UPUSERID,
		                FILE_SEQ AS FILESEQ,
		                SUB_SEQ AS SUBSEQ,
                        (SELECT COUNT(*) FROM LIKE_BOARD C WHERE C.BOARD_SEQ = D.BOARD_SEQ AND C.KIND = 0) AS LOVE,
                        (SELECT COUNT(*) FROM LIKE_BOARD C WHERE C.BOARD_SEQ = D.BOARD_SEQ AND C.KIND = 1) AS HATE
		            FROM BROWNIE_BOARD D
		            WHERE 1 = 1
		            AND BOARD_CATEGORY = 'GALLERY'
		            ORDER BY BOARD_SEQ DESC
		    )T
		)S

    </select>

    <select id="read" parameterType="int" resultType="kr.co.brownie.gallery.service.GalleryVO">
        SELECT BOARD_SEQ  AS BOARDSEQ,
               BOARD_KIND AS BOARDKIND,
               TITLE      AS TITLE,
               CONTENT    AS CONTENT,
               NOTICE_YN  AS NOTICEYN,
               STATUS     AS STATUS,
               IN_DATE    AS INDATE,
               IN_USER_ID AS INUSERID,
               UP_DATE    AS "UPDATE",
               UP_USER_ID AS UPUSERID,
               FILE_SEQ   AS FILESEQ,
               SUB_SEQ    AS SUBSEQ
        FROM BROWNIE_BOARD
        WHERE BOARD_SEQ = #{boardSeq}
    </select>
    
    <insert id="insert" parameterType="hashMap">
        <selectKey order="BEFORE" keyProperty="boardSeq" resultType="int">
            SELECT NVL(MAX(BOARD_SEQ),0)+1 FROM BROWNIE_BOARD
        </selectKey>
        INSERT INTO
        BROWNIE_BOARD(BOARD_SEQ,BOARD_KIND,TITLE,CONTENT,NOTICE_YN,STATUS,IN_DATE,IN_USER_ID,UP_DATE,UP_USER_ID,FILE_SEQ,SUB_SEQ)
        VALUES (#{boardSeq},'GALLERY',#{title},#{content},'n',NULL,SYSDATE,#{inUserId},SYSDATE,#{inUserId},#{fileSeq},NULL)
    </insert>
    
    <insert id="insertThumb" parameterType="hashMap">
        INSERT INTO
        BROWNIE_FILE(FILE_SEQ,SUB_SEQ,FILE_PATH,ORIGINAL_NAME,SAVE_NAME,IN_DATE,IN_USER_ID,UP_DATE,UP_USER_ID)
        VALUES ((SELECT NVL(MAX(FILE_SEQ),0)+1 FROM BROWNIE_FILE),1,NULL,NULL,#{fileName},SYSDATE,#{inUserId},SYSDATE,#{inUserId})
    </insert>

    <update id="update" parameterType="hashMap">
        UPDATE BROWNIE_BOARD
        SET BOARD_KIND = 'GALLERY',
            TITLE      = #{title},
            CONTENT    = #{content},
            NOTICE_YN  = 1,
            STATUS     = 1,
            UP_DATE    = SYSDATE,
            FILE_SEQ   = #{fileSeq},
            SUB_SEQ    = NULL
        WHERE BOARD_SEQ = #{boardSeq}
    </update>

    <delete id="delete" parameterType="int">
        DELETE
        FROM BROWNIE_BOARD
        WHERE BOARD_SEQ = #{Seq}
    </delete>
    
    <select id="count" resultType="int">
        SELECT COUNT(*) CNT FROM BROWNIE_BOARD WHERE BOARD_KIND='GALLERY'
    </select>
    
    <select id="galleryAB" resultType="kr.co.brownie.reply.service.ReplyVO">
		SELECT
			BOARDSEQ,
			REPLYCNT,
			BEFORESEQ,
			BEFOREDATE,
			BEFORECNT,
			AFTERSEQ,
			AFTERDATE,
			AFTERCNT
		FROM
			(
			SELECT
				BOARDSEQ,
				REPLYCNT,
				LAG(BOARDSEQ) OVER(ORDER BY BOARDSEQ) AS BEFORESEQ,
				LAG(INDATE) OVER(ORDER BY BOARDSEQ) AS BEFOREDATE,
				LAG(REPLYCNT) OVER(ORDER BY BOARDSEQ) AS BEFORECNT,
				LEAD(BOARDSEQ) OVER(ORDER BY BOARDSEQ) AS AFTERSEQ,
				LEAD(INDATE) OVER(ORDER BY BOARDSEQ) AS AFTERDATE,
				LEAD(REPLYCNT) OVER(ORDER BY BOARDSEQ) AS AFTERCNT
			FROM
				(
				SELECT
					BB.BOARD_SEQ BOARDSEQ,
                	BB.IN_DATE INDATE,
			        NVL(RE.CNT,0) REPLYCNT
	        	FROM
	        		BROWNIE_BOARD BB
	        	LEFT JOIN
	        		(
	        		SELECT
	        			BOARD_SEQ,
	        			COUNT(REPLY_SEQ) CNT
			      	FROM
			      		REPLY
			      	GROUP BY
			      		BOARD_SEQ
			      	) RE
		     	ON (BB.BOARD_SEQ = RE.BOARD_SEQ)
		     	WHERE UPPER(BB.BOARD_KIND)='GALLERY'
		     	ORDER BY BOARDSEQ
				)
			)
		WHERE BOARDSEQ = ${boardSeq}
	</select>
    
</mapper>

